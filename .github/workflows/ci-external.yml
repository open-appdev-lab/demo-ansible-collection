name: CI-External

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [ "main" ]
  merge_group:
    types: [checks_requested]
concurrency:
  group: external-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  external-approval:
    if: github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    environment: external-ci  # Enforce manual gate
    steps:
      - run: echo "Approval received, starting CI..."

  external-ci:
    needs: external-approval
    uses: open-appdev-lab/ansible-collections-ci/.github/workflows/ci-ansible-collection.yml@main
    permissions:
      contents: write
      packages: write
      security-events: write
      actions: read
    with:
      ref: ${{ github.event.pull_request.head.sha }}
      repo: ${{ github.event.pull_request.head.repo.full_name }}
    secrets:
      automation_hub_token: ${{ secrets.AUTOMATION_HUB_TOKEN }}
      release_app_id:  ${{ secrets.RELEASE_APP_ID }}
      release_app_private_key:  ${{ secrets.RELEASE_APP_PRIVATE_KEY }}