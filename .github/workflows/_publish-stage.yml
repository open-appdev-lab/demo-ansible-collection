name: Publish stage

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string
      automation_hub_url:
        required: false
        type: string
        default: 'https://console.redhat.com/api/automation-hub/'
        description: 'The API URL for the Automation Hub'
      tag_name:
        required: true
        type: string
    secrets:
      automation_hub_token:
        required: true
        description: 'The Authentication Token for the Hub'

jobs:
  package-publisher-github:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-tags: true # Explicitly ensures tags are pulled

    - name: Publish | download-collection
      uses: actions/download-artifact@v4
      with:
        name: build-asset

    - name: Publish | package-publisher-github
      id: package-publisher-github
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global --add safe.directory .
        semantic-release -vv publish --tag ${{ inputs.tag_name }}

  package-publisher-automation-hub:
    runs-on: ubuntu-latest
    # environment: ${{ inputs.environment }}
    steps:
    - name: Publish | download-collection
      uses: actions/download-artifact@v4
      with:
        name: build-asset
    - name: Publish | package-publisher-automation-hub
      id: package-publisher-automation-hub
      env:
        AUTOMATION_HUB_URL: ${{ vars.HUB_URL || 'https://console.redhat.com/api/automation-hub/' }}
        AUTOMATION_HUB_TOKEN: ${{ secrets.AUTOMATION_HUB_TOKEN }}
      run: |
        ansible-galaxy collection publish ./*.tar.gz \
          --server "$AUTOMATION_HUB_URL" \
          --token "$AUTOMATION_HUB_TOKEN"
