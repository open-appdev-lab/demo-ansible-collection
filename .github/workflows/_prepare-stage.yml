name: Prepare stage

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string
      automation_hub_url:
        required: false
        type: string
        default: 'https://console.redhat.com/api/automation-hub/'
        description: 'The API URL for the Automation Hub'
        
    secrets:
      automation_hub_token:
        required: true
        description: 'The Authentication Token for the Hub'
jobs:
  semver-next:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Prepare | semver-next
      run: |
        git config --global --add safe.directory .
        echo "NEXT_VERSION=$(semantic-release version --print-tag)" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ansible-validate-tokens:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
    # - uses: actions/checkout@v4

    - name: Prepare | ansible-validate-tokens
      id: ansible-validate-tokens
      env:
          AUTOMATION_HUB_URL: ${{ inputs.automation_hub_url }}
          AUTOMATION_HUB_TOKEN: ${{ secrets.automation_hub_token }}
          # Validate Automation Hub Certified Token"
          # AUTOMATION_HUB_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_AUTOMATION_HUB_CERTIFIED_TOKEN }}
          # Validate Automation Hub Validated Token"
          # AUTOMATION_HUB_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_AUTOMATION_HUB_VALIDATED_TOKEN }}
      run: |

        echo "Starting Token Validation..."
        
        if [[ -z "${AUTOMATION_HUB_TOKEN}" ]]; then
          echo "AUTOMATION_HUB_TOKEN is not defined. Exiting"
          exit 1
        fi

        echo "Starting Token Validation..."
                  
        # DETECT HUB TYPE BASED ON URL
        if [[ "$AUTOMATION_HUB_URL" == *"console.redhat.com"* ]]; then
            echo "Type: Red Hat SaaS (console.redhat.com)"
            echo "Action: Verifying Offline Token via SSO exchange..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token \
                -d grant_type=refresh_token \
                -d client_id="cloud-services" \
                -d refresh_token="$AUTOMATION_HUB_TOKEN")
                
            if [[ "$HTTP_CODE" == "200" ]]; then
                echo "✅ Success: Red Hat Offline Token is valid."
            else
                echo "❌ Error: Token rejected by Red Hat SSO (HTTP $HTTP_CODE)."
                exit 1
            fi

        else
            echo "Type: Private Automation Hub (On-Premise)"
            echo "Action: Verifying Bearer Token against $AUTOMATION_HUB_URL..."

            # Ensure URL ends with / if not present (simple cleanup)
            BASE_URL="${AUTOMATION_HUB_URL%/}"
                      
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -H "Authorization: Bearer $AUTOMATION_HUB_TOKEN" \
                "$BASE_URL/v3/namespaces/?limit=1")
          
            if [[ "$HTTP_CODE" == "200" ]]; then
                echo "✅ Success: Private Hub Token is valid."
            elif [[ "$HTTP_CODE" == "401" ]] || [[ "$HTTP_CODE" == "403" ]]; then
                echo "❌ Error: Unauthorized. Check your Private Hub Token (HTTP $HTTP_CODE)."
                exit 1
            else
                echo "⚠️ Warning: Received HTTP $HTTP_CODE."
                echo "Expected 200 OK from $BASE_URL/v3/namespaces/"
                exit 1
            fi
        fi

  ansible-collection-install:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
    - uses: actions/checkout@v4

    - name: Prepare | ansible-collection-install (1/2)
      id: ansible-collection-install
      run: |
        ANSIBLE_COLLECTIONS_PATH=.ansible/collections
        ansible-galaxy collection install --force -p .ansible/collections -r requirements-dev.yml || RETURN=$?
        if [[ 0 == $RETURN ]]; then
          echo "Return code $RETURN matches expected return"
          exit 0
        fi
        exit $RETURN

    - name: Prepare | ansible-collection-install (2/2)
      uses: actions/upload-artifact@v4
      if: always() && steps.ansible-collection-install.outcome != 'skipped'
      with:
        name: local-ansible-collections
        path: .ansible/
        if-no-files-found: error
        include-hidden-files: true
